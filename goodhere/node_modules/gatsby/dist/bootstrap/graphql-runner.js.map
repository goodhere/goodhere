{"version":3,"sources":["../../src/bootstrap/graphql-runner.js"],"names":["stackTrace","require","GraphQLRunner","default","errorParser","emitter","module","exports","store","reporter","runner","forEach","eventType","on","event","query","context","then","result","errors","structuredErrors","map","e","file","parse","find","test","functionName","structuredError","message","location","start","line","lineNumber","column","columnNumber","filePath","fileName","fromGraphQLFunction","filter","Boolean","length","panicOnBuild"],"mappings":";;AAAA,MAAMA,UAAU,GAAGC,OAAO,CAAE,aAAF,CAA1B;;AAEA,MAAMC,aAAa,GAAGD,OAAO,CAAE,yBAAF,CAAP,CAAmCE,OAAzD;;AACA,MAAMC,WAAW,GAAGH,OAAO,CAAE,uBAAF,CAAP,CAAiCE,OAArD;;AAEA,MAAM;AAAEE,EAAAA;AAAF,IAAcJ,OAAO,CAAE,UAAF,CAA3B;;AAEAK,MAAM,CAACC,OAAP,GAAiB,CAACC,KAAD,EAAQC,QAAR,KAAqB;AACpC;AACA,MAAIC,MAAM,GAAG,IAAIR,aAAJ,CAAkBM,KAAlB,CAAb;AACC,GACE,cADF,EAEE,aAFF,EAGE,aAHF,EAIE,cAJF,EAKE,qBALF,EAME,YANF,EAOE,mBAPF,EAQE,+BARF,EASCG,OATD,CASSC,SAAS,IAAI;AACrBP,IAAAA,OAAO,CAACQ,EAAR,CAAWD,SAAX,EAAsBE,KAAK,IAAI;AAC7BJ,MAAAA,MAAM,GAAG,IAAIR,aAAJ,CAAkBM,KAAlB,CAAT;AACD,KAFD;AAGD,GAbA;AAcD,SAAO,CAACO,KAAD,EAAQC,OAAR,KACLN,MAAM,CAACK,KAAP,CAAaA,KAAb,EAAoBC,OAApB,EAA6BC,IAA7B,CAAkCC,MAAM,IAAI;AAC1C,QAAIA,MAAM,CAACC,MAAX,EAAmB;AACjB,YAAMC,gBAAgB,GAAGF,MAAM,CAACC,MAAP,CACtBE,GADsB,CAClBC,CAAC,IAAI;AACR;AACA,cAAMC,IAAI,GAAGvB,UAAU,CACpBwB,KADU,CACJF,CADI,EAEVG,IAFU,CAELF,IAAI,IAAI,cAAcG,IAAd,CAAmBH,IAAI,CAACI,YAAxB,CAFH,CAAb;;AAIA,YAAIJ,IAAJ,EAAU;AACR,gBAAMK,eAAe,GAAGxB,WAAW,CAAC;AAClCyB,YAAAA,OAAO,EAAEP,CAAC,CAACO,OADuB;AAElCC,YAAAA,QAAQ,EAAE;AACRC,cAAAA,KAAK,EAAE;AAAEC,gBAAAA,IAAI,EAAET,IAAI,CAACU,UAAb;AAAyBC,gBAAAA,MAAM,EAAEX,IAAI,CAACY;AAAtC;AADC,aAFwB;AAKlCC,YAAAA,QAAQ,EAAEb,IAAI,CAACc;AALmB,WAAD,CAAnC;AAOAT,UAAAA,eAAe,CAACZ,OAAhB,GAA0B,EACxB,GAAGY,eAAe,CAACZ,OADK;AAExBsB,YAAAA,mBAAmB,EAAE;AAFG,WAA1B;AAIA,iBAAOV,eAAP;AACD;;AAED,eAAO,IAAP;AACD,OAvBsB,EAwBtBW,MAxBsB,CAwBfC,OAxBe,CAAzB;;AA0BA,UAAIpB,gBAAgB,CAACqB,MAArB,EAA6B;AAC3B;AACAhC,QAAAA,QAAQ,CAACiC,YAAT,CAAsBtB,gBAAtB;AACD;AACF;;AAED,WAAOF,MAAP;AACD,GAnCD,CADF;AAqCD,CAtDD","sourcesContent":["const stackTrace = require(`stack-trace`)\n\nconst GraphQLRunner = require(`../query/graphql-runner`).default\nconst errorParser = require(`../query/error-parser`).default\n\nconst { emitter } = require(`../redux`)\n\nmodule.exports = (store, reporter) => {\n  // TODO: Move tracking of changed state inside GraphQLRunner itself. https://github.com/gatsbyjs/gatsby/issues/20941\n  let runner = new GraphQLRunner(store)\n  ;[\n    `DELETE_CACHE`,\n    `CREATE_NODE`,\n    `DELETE_NODE`,\n    `DELETE_NODES`,\n    `SET_SCHEMA_COMPOSER`,\n    `SET_SCHEMA`,\n    `ADD_FIELD_TO_NODE`,\n    `ADD_CHILD_NODE_TO_PARENT_NODE`,\n  ].forEach(eventType => {\n    emitter.on(eventType, event => {\n      runner = new GraphQLRunner(store)\n    })\n  })\n  return (query, context) =>\n    runner.query(query, context).then(result => {\n      if (result.errors) {\n        const structuredErrors = result.errors\n          .map(e => {\n            // Find the file where graphql was called.\n            const file = stackTrace\n              .parse(e)\n              .find(file => /createPages/.test(file.functionName))\n\n            if (file) {\n              const structuredError = errorParser({\n                message: e.message,\n                location: {\n                  start: { line: file.lineNumber, column: file.columnNumber },\n                },\n                filePath: file.fileName,\n              })\n              structuredError.context = {\n                ...structuredError.context,\n                fromGraphQLFunction: true,\n              }\n              return structuredError\n            }\n\n            return null\n          })\n          .filter(Boolean)\n\n        if (structuredErrors.length) {\n          // panic on build exits the process\n          reporter.panicOnBuild(structuredErrors)\n        }\n      }\n\n      return result\n    })\n}\n"],"file":"graphql-runner.js"}